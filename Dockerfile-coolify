FROM node:22.8.0

WORKDIR /app

# Disable Corepack (avoid TUF/signature issues) and install pnpm + wrangler globally
RUN corepack disable || true && \
    npm install -g pnpm@9.12.2 wrangler

# Copy only dependency files first for better caching
COPY package.json pnpm-lock.yaml ./

# Install deps strictly per lockfile
RUN pnpm install --frozen-lockfile

# Copy the rest of the project
COPY . .

# Normalize line endings & ensure script is executable
RUN tr -d '\r' < bindings.sh > bindings.tmp \
 && mv bindings.tmp bindings.sh \
 && chmod +x bindings.sh

# Build the app
RUN pnpm run build

EXPOSE 5173

ENV NODE_ENV=production \
    RUNNING_IN_DOCKER=true

CMD ["pnpm", "run", "dockerstart"]
